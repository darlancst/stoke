{% extends 'inventario/base.html' %}

{% block title %}Incluir no Estoque - {{ produto_chegando.nome }}{% endblock %}

{% block content %}
<h1 class="mb-3">Incluir no Estoque</h1>

<div class="alert alert-info">
    <h5><i class="bi bi-info-circle"></i> Produto Chegando</h5>
    <p class="mb-1"><strong>Nome:</strong> {{ produto_chegando.nome }}</p>
    <p class="mb-1"><strong>Quantidade:</strong> {{ produto_chegando.quantidade }} unidades</p>
    <p class="mb-0"><strong>Preço de Compra:</strong> R$ {{ produto_chegando.preco_compra|floatformat:2 }}</p>
</div>

<div class="card">
    <div class="card-body">
        <h5 class="mb-3">Dados para Incluir no Estoque</h5>
        <p class="text-muted">Complete os dados para adicionar este produto ao seu estoque de vendas.</p>
        
        <div class="row g-3">
            <div class="col-12 col-md-6">
                <label class="form-label">Preço de Venda (R$) *</label>
                <input type="number" id="preco_venda" class="form-control" min="0" step="0.01" 
                       {% if produto_vinculado %}value="{{ produto_vinculado.preco_venda|floatformat:2 }}"{% endif %} 
                       required>
                <small class="text-muted">
                    {% if produto_vinculado %}
                        Preço atual do produto no estoque
                    {% else %}
                        Por quanto você vai vender cada unidade
                    {% endif %}
                </small>
            </div>
            
            <div class="col-12">
                {% if produto_vinculado %}
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> 
                    <strong>Produto Vinculado:</strong> Este produto chegando está vinculado ao produto 
                    "<strong>{{ produto_vinculado.nome }}</strong>" no estoque. Ao incluir, será adicionado 
                    um novo lote de {{ produto_chegando.quantidade }} unidades ao produto existente.
                    <br><small>Estoque atual: {{ produto_vinculado.quantidade_total }} unidades</small>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> 
                    <strong>Atenção:</strong> Se já existir um produto com o nome "{{ produto_chegando.nome }}" no estoque, 
                    apenas um novo lote será adicionado a ele. Caso contrário, um novo produto será criado.
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="text-end mt-3">
            <a href="{% url 'inventario:listar_produtos_chegando' %}" class="btn btn-secondary">Cancelar</a>
            <button class="btn btn-success" id="btn-incluir">
                <i class="bi bi-box-arrow-in-down"></i> Incluir no Estoque
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btnIncluir = document.getElementById('btn-incluir');
    
    if (!btnIncluir) {
        console.error('ERRO: Botão #btn-incluir não encontrado!');
        return;
    }
    
    btnIncluir.addEventListener('click', function() {
    const preco_venda_input = document.getElementById('preco_venda');
    
    if (!preco_venda_input) {
        alert('Erro: Campo de preço de venda não encontrado.');
        return;
    }
    
    const preco_venda = parseFloat(preco_venda_input.value);
    
    if (isNaN(preco_venda) || preco_venda <= 0) {
        alert('Preço de venda deve ser maior que zero.');
        return;
    }
    
    // Validação adicional: se não há produto vinculado, o preço de venda não pode ser igual ao de compra
    {% if not produto_vinculado %}
    const preco_compra = parseFloat({{ produto_chegando.preco_compra }});
    
    if (preco_venda === preco_compra) {
        alert('O preço de venda não pode ser igual ao preço de compra. Por favor, defina um preço de venda adequado.');
        return;
    }
    {% endif %}
    
    const payload = {
        preco_venda: preco_venda
    };
    
    btnIncluir.disabled = true;
    btnIncluir.innerHTML = '<i class="bi bi-hourglass-split"></i> Processando...';
    
    const url = '{% url "inventario:incluir_no_estoque" pk=produto_chegando.pk %}';
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(payload)
    })
    .then(response => {
        // Tenta ler a resposta JSON mesmo se der erro
        return response.json().then(data => {
            if (!response.ok) {
                throw new Error(data.erro || 'Erro HTTP ' + response.status);
            }
            return data;
        });
    })
    .then(data => {
        if (data.sucesso) {
            alert('Produto incluído no estoque com sucesso!');
            window.location.href = '{% url "inventario:listar_produtos" %}';
        } else {
            alert('Erro: ' + data.erro);
            btnIncluir.disabled = false;
            btnIncluir.innerHTML = '<i class="bi bi-box-arrow-in-down"></i> Incluir no Estoque';
        }
    })
    .catch((error) => {
        alert('Erro: ' + error.message);
        btnIncluir.disabled = false;
        btnIncluir.innerHTML = '<i class="bi bi-box-arrow-in-down"></i> Incluir no Estoque';
    });
});
});
</script>
{% endblock %}

