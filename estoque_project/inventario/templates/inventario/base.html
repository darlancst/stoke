<!DOCTYPE html>
<html lang="pt-br">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Gestão de Estoque{% endblock %}</title>
    
    <!-- Script CRÍTICO: Aplicar tema ANTES de renderizar para evitar flash -->
    <script>
        (function() {
            function getPreferredTheme() {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme) return savedTheme;
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            // Aplica o tema IMEDIATAMENTE, antes de qualquer CSS
            document.documentElement.setAttribute('data-theme', getPreferredTheme());
        })();
    </script>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="manifest" href="{% static 'manifest.webmanifest' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'icons/favicon.ico' %}">
    <link rel="apple-touch-icon" sizes="192x192" href="{% static 'icons/icon-192.png' %}">
    <meta name="theme-color" content="#0d1117">
    {% block extra_head %}{% endblock %}
    <style>
        body {
            font-size: .875rem;
        }
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0; /* Mantém apenas para desktop */
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
        }
        
        /* Ajustes para mobile - REMOVIDO - consolidado no bloco principal abaixo */
        .sidebar-sticky {
            position: relative;
            top: 0;
            height: calc(100vh - 48px);
            padding-top: 0; /* Removido espaço extra no topo */
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        /* Sidebar-sticky em mobile: altura automática */
        @media (max-width: 767.98px) {
            .sidebar-sticky {
                height: auto !important;
                overflow: visible !important;
            }
        }
        
        /* Estilização personalizada do botão hambúrguer */
        .navbar-toggler {
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            background-color: rgba(255, 255, 255, 0.08);
            transition: background-color 0.2s ease;
            margin-right: 15px;
        }
        
        .navbar-toggler:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        
        .navbar-toggler:focus {
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.25);
            outline: none;
        }
        
        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 0.8%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='m4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }
        
        /* Melhoria no nome da marca */
        .navbar-brand {
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        
        /* Botão de Toggle de Tema */
        #theme-toggle {
            background-color: rgba(255, 255, 255, 0.08);
            border: none;
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        #theme-toggle:hover {
            background-color: rgba(255, 255, 255, 0.15);
            transform: scale(1.05);
        }
        
        #theme-toggle:active {
            transform: scale(0.95);
        }
        
        #theme-icon {
            font-size: 1.1rem;
        }
        
        /* Botão de Ajuda/Recursos */
        #help-toggle {
            background-color: rgba(255, 255, 255, 0.08);
            border: none;
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        #help-toggle:hover {
            background-color: rgba(255, 255, 255, 0.15);
            transform: scale(1.05);
        }
        
        #help-toggle:active {
            transform: scale(0.95);
        }
        
        #help-toggle .bi {
            font-size: 1.1rem;
        }
        
        /* Transições suaves para mudança de tema */
        body, .card, .table, .sidebar, .form-control, .form-select, .btn, .badge, .alert {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        
        /* ========== DARK MODE STYLES ========== */
        [data-theme="dark"] {
            color-scheme: dark;
        }
        
        [data-theme="dark"] body {
            background-color: #0d1117;
            color: #c9d1d9;
        }
        
        [data-theme="dark"] .sidebar {
            background-color: #161b22 !important;
            box-shadow: inset -1px 0 0 rgba(255, 255, 255, .1);
        }
        
        [data-theme="dark"] .nav-link {
            color: #8b949e;
        }
        
        [data-theme="dark"] .nav-link:hover {
            color: #58a6ff;
            background-color: rgba(88, 166, 255, 0.1);
        }
        
        [data-theme="dark"] .nav-link.active {
            color: #58a6ff;
            background-color: rgba(88, 166, 255, 0.15);
        }
        
        [data-theme="dark"] .sidebar-heading {
            color: #8b949e !important;
        }
        
        [data-theme="dark"] .card {
            background-color: #161b22;
            border-color: #30363d;
            color: #c9d1d9;
        }
        
        [data-theme="dark"] .card-header {
            background-color: #0d1117;
            border-bottom-color: #30363d;
            color: #c9d1d9;
        }
        
        [data-theme="dark"] .table {
            /* Ajuste robusto usando CSS vars do Bootstrap para evitar fundo branco */
            --bs-table-color: #c9d1d9;
            --bs-table-bg: transparent;
            --bs-table-striped-bg: rgba(88, 166, 255, 0.02);
            --bs-table-hover-bg: rgba(88, 166, 255, 0.08);
            --bs-table-border-color: #30363d;
            color: #c9d1d9;
            border-color: #30363d;
        }
        
        [data-theme="dark"] .table thead th {
            background-color: #0d1117;
            border-color: #30363d;
            color: #c9d1d9;
        }
        
        [data-theme="dark"] .table tbody tr {
            border-color: #30363d;
        }
        
        [data-theme="dark"] .table tbody tr:hover {
            background-color: rgba(88, 166, 255, 0.05);
        }
        
        [data-theme="dark"] .form-control,
        [data-theme="dark"] .form-select {
            background-color: #0d1117;
            border-color: #30363d;
            color: #c9d1d9;
        }
        
        [data-theme="dark"] .form-control:focus,
        [data-theme="dark"] .form-select:focus {
            background-color: #0d1117;
            border-color: #58a6ff;
            color: #c9d1d9;
        }
        
        [data-theme="dark"] .form-control::placeholder {
            color: #6e7681;
        }
        
        [data-theme="dark"] .btn-outline-secondary {
            color: #8b949e;
            border-color: #30363d;
        }
        
        [data-theme="dark"] .btn-outline-secondary:hover {
            background-color: #30363d;
            border-color: #30363d;
            color: #c9d1d9;
        }
        
        [data-theme="dark"] .text-muted {
            color: #8b949e !important;
        }
        /* Títulos no dark mode */
        [data-theme="dark"] h1,
        [data-theme="dark"] h2,
        [data-theme="dark"] h3,
        [data-theme="dark"] h4,
        [data-theme="dark"] h5,
        [data-theme="dark"] h6 {
            color: #c9d1d9;
        }
        [data-theme="dark"] .card-title,
        [data-theme="dark"] .modal-title,
        [data-theme="dark"] .table > caption {
            color: #c9d1d9;
        }
        
        [data-theme="dark"] .border {
            border-color: #30363d !important;
        }
        
        [data-theme="dark"] .alert-info {
            background-color: rgba(88, 166, 255, 0.1);
            border-color: #388bfd;
            color: #79c0ff;
        }
        
        [data-theme="dark"] .alert-warning {
            background-color: rgba(255, 191, 0, 0.1);
            border-color: #d29922;
            color: #ffc66d;
        }
        
        [data-theme="dark"] .alert-success {
            background-color: rgba(63, 185, 80, 0.1);
            border-color: #2ea043;
            color: #7ee787;
        }
        
        [data-theme="dark"] .alert-danger {
            background-color: rgba(248, 81, 73, 0.1);
            border-color: #da3633;
            color: #ff7b72;
        }
        
        [data-theme="dark"] .badge {
            border: 1px solid #30363d;
        }
        
        [data-theme="dark"] .list-group-item {
            background-color: #161b22;
            border-color: #30363d;
            color: #c9d1d9;
        }
        
        [data-theme="dark"] .list-group-item:hover {
            background-color: rgba(88, 166, 255, 0.05);
        }
        
        [data-theme="dark"] hr {
            border-color: #30363d;
            opacity: 1;
        }
        
        [data-theme="dark"] .modal-content {
            background-color: #161b22;
            border-color: #30363d;
        }
        
        [data-theme="dark"] .modal-header {
            border-bottom-color: #30363d;
        }
        
        [data-theme="dark"] .modal-footer {
            border-top-color: #30363d;
        }
        
        [data-theme="dark"] .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        
        [data-theme="dark"] kbd {
            background-color: #30363d;
            color: #c9d1d9;
            border-color: #484f58;
        }
        
        [data-theme="dark"] .dropdown-menu {
            background-color: #161b22;
            border-color: #30363d;
        }
        
        [data-theme="dark"] .dropdown-item {
            color: #c9d1d9;
        }
        
        [data-theme="dark"] .dropdown-item:hover {
            background-color: rgba(88, 166, 255, 0.1);
            color: #58a6ff;
        }
        
        /* Ajustes para autocomplete jQuery UI */
        [data-theme="dark"] .ui-autocomplete {
            background-color: #161b22 !important;
            border-color: #30363d !important;
        }
        
        [data-theme="dark"] .ui-menu-item {
            color: #c9d1d9 !important;
        }
        
        [data-theme="dark"] .ui-state-active,
        [data-theme="dark"] .ui-state-focus {
            background-color: rgba(88, 166, 255, 0.15) !important;
            border-color: #58a6ff !important;
            color: #58a6ff !important;
        }
        
        /* Ajustes para heatmap no dark mode */
        [data-theme="dark"] .heatmap-day {
            border-color: #21262d;
        }
        
        [data-theme="dark"] .heatmap-day[data-level="0"] {
            background-color: #161b22;
        }
        
        [data-theme="dark"] .heatmap-day[data-level="1"] {
            background-color: rgba(88, 166, 255, 0.2);
        }
        
        [data-theme="dark"] .heatmap-day[data-level="2"] {
            background-color: rgba(88, 166, 255, 0.4);
        }
        
        [data-theme="dark"] .heatmap-day[data-level="3"] {
            background-color: rgba(88, 166, 255, 0.6);
        }
        
        [data-theme="dark"] .heatmap-day[data-level="4"] {
            background-color: rgba(88, 166, 255, 0.8);
        }
        
        /* Ajustes de texto para inputs desabilitados */
        [data-theme="dark"] .form-control:disabled,
        [data-theme="dark"] .form-select:disabled {
            background-color: #0d1117;
            color: #6e7681;
            opacity: 0.7;
        }
        
        /* Links dentro de cards, tables, list-groups */
        [data-theme="dark"] .card a,
        [data-theme="dark"] .table a,
        [data-theme="dark"] .list-group a {
            color: #58a6ff;
            text-decoration: none;
        }
        
        [data-theme="dark"] .card a:hover,
        [data-theme="dark"] .table a:hover,
        [data-theme="dark"] .list-group a:hover {
            color: #79c0ff;
            text-decoration: underline;
        }
        
        /* Tabelas striped no dark mode */
        [data-theme="dark"] .table-striped > tbody > tr:nth-of-type(odd) > * {
            background-color: rgba(88, 166, 255, 0.02);
        }
        
        /* Table hover no dark mode */
        [data-theme="dark"] .table-hover > tbody > tr:hover > * {
            background-color: rgba(88, 166, 255, 0.08);
        }
        
        /* Table thead sem classe específica */
        [data-theme="dark"] .table > thead {
            background-color: #0d1117;
            color: #c9d1d9;
            border-color: #30363d;
        }
        
        [data-theme="dark"] .table > thead > tr > th {
            border-color: #30363d;
        }
        
        /* Ajuste para heatmap legend no dark mode */
        [data-theme="dark"] .heatmap-legend-cell {
            border: 1px solid #30363d;
        }
        
        /* ========== TRUNCAMENTO DE TEXTO EM MOBILE ========== */
        @media (max-width: 767.98px) {
            /* Trunca texto longo em tabelas mobile */
            .table td:not(.text-center):not(.text-end) {
                max-width: 150px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            /* Permite quebra de linha em listas pequenas de itens */
            .table td .small,
            .table td .list-unstyled li {
                white-space: normal;
                overflow-wrap: break-word;
                word-break: break-word;
            }
            
            /* Trunca texto em cards mobile */
            .card-body .text-truncate {
                max-width: 100%;
            }
            
            /* Inputs e selects ajustados */
            .form-control,
            .form-select {
                font-size: 16px !important; /* Previne zoom no iOS */
            }
            
            /* Trunca badges longos mas mantém visibilidade */
            .badge {
                max-width: fit-content;
                overflow: hidden;
                text-overflow: ellipsis;
                display: inline-block;
            }
            
            /* Links longos em mobile */
            .card a:not(.btn),
            .table a:not(.btn) {
                word-break: break-word;
                overflow-wrap: break-word;
            }
            
            /* Nomes de produtos e clientes em cards */
            .card-body strong,
            .card-body .fw-bold,
            .card-body .fw-semibold {
                word-break: break-word;
                overflow-wrap: break-word;
            }
        }
        
        /* ========== RESPONSIVIDADE GERAL ========== */
        /* Garantir que conteúdo não vaze do container */
        .card-body,
        .table-responsive {
            overflow-x: auto;
        }
        
        /* Quebra de linha inteligente para textos longos */
        .text-break-mobile {
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        @media (max-width: 767.98px) {
            .text-break-mobile {
                word-break: break-word !important;
            }
        }
        
        /* Ajuste para small text dentro de badges/cards */
        [data-theme="dark"] .badge .text-muted,
        [data-theme="dark"] .card-body .text-muted {
            color: #8b949e !important;
        }
        
        /* Ajuste para inputs do tipo date no dark mode */
        [data-theme="dark"] input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        
        /* Box shadow para cards no dark mode */
        [data-theme="dark"] .dashboard-card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        [data-theme="dark"] .dashboard-card:hover {
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4);
        }
        
        /* Canvas background para gráficos */
        [data-theme="dark"] canvas {
            background-color: transparent;
        }
        
        /* Table-light (cabeçalhos de tabela) no dark mode */
        [data-theme="dark"] .table-light,
        [data-theme="dark"] .table-light > th,
        [data-theme="dark"] .table-light > td {
            background-color: #0d1117 !important;
            color: #c9d1d9 !important;
            border-color: #30363d !important;
        }
        /* Garante linhas com fundo claro sejam escurecidas no dark */
        [data-theme="dark"] .table > :not(caption) > * > * {
            background-color: transparent !important;
            box-shadow: inset 0 0 0 9999px rgba(0,0,0,0); /* remove overlay branco do Bootstrap */
        }
        
        /* Table-secondary no dark mode */
        [data-theme="dark"] .table-secondary {
            background-color: rgba(88, 166, 255, 0.05) !important;
        }
        
        /* Background light no dark mode */
        [data-theme="dark"] .bg-light {
            background-color: #161b22 !important;
        }
        
        /* Background white no dark mode */
        [data-theme="dark"] .bg-white {
            background-color: #161b22 !important;
        }
        
        /* Cards aninhados (cards dentro de cards) */
        [data-theme="dark"] .card .card {
            background-color: #0d1117;
            border-color: #30363d;
        }
        
        /* Texto com classes do Bootstrap */
        [data-theme="dark"] .text-dark {
            color: #c9d1d9 !important;
        }
        
        /* Botões info no dark mode */
        [data-theme="dark"] .btn-info {
            background-color: #30363d;
            border-color: #30363d;
            color: #58a6ff;
        }
        [data-theme="dark"] .btn-info:hover {
            background-color: #484f58;
            border-color: #484f58;
            color: #79c0ff;
        }
        /* Botões warning no dark mode */
        [data-theme="dark"] .btn-warning {
            background-color: #d97706;
            border-color: #d97706;
            color: #fff;
        }
        
        [data-theme="dark"] .btn-warning:hover {
            background-color: #f59e0b;
            border-color: #f59e0b;
            color: #fff;
        }
        
        /* Botões success no dark mode */
        [data-theme="dark"] .btn-success {
            background-color: #059669;
            border-color: #059669;
            color: #fff;
        }
        
        [data-theme="dark"] .btn-success:hover {
            background-color: #10b981;
            border-color: #10b981;
            color: #fff;
        }
        
        /* Botões secondary no dark mode */
        [data-theme="dark"] .btn-secondary {
            background-color: #30363d;
            border-color: #30363d;
            color: #c9d1d9;
        }
        
        [data-theme="dark"] .btn-secondary:hover {
            background-color: #484f58;
            border-color: #484f58;
            color: #fff;
        }
        
        /* Botões primary no dark mode */
        [data-theme="dark"] .btn-primary {
            background-color: #1d4ed8;
            border-color: #1d4ed8;
            color: #fff;
        }
        
        [data-theme="dark"] .btn-primary:hover {
            background-color: #3b82f6;
            border-color: #3b82f6;
            color: #fff;
        }
        
        /* Botões danger no dark mode */
        [data-theme="dark"] .btn-danger {
            background-color: #da3633;
            border-color: #da3633;
            color: #fff;
        }
        
        [data-theme="dark"] .btn-danger:hover {
            background-color: #f85149;
            border-color: #f85149;
            color: #fff;
        }
 
         /* Garantir ícones visíveis e com contraste em botões no dark mode */
         [data-theme="dark"] .btn .bi {
             color: currentColor;
             opacity: 1;
         }
 
         /* Força a cor correta em botões específicos */
         [data-theme="dark"] .btn-primary .bi,
         [data-theme="dark"] .btn-success .bi,
         [data-theme="dark"] .btn-danger .bi,
         [data-theme="dark"] .btn-warning .bi,
         [data-theme="dark"] .btn-info .bi {
             color: #fff;
         }
 
         [data-theme="dark"] .btn-secondary .bi {
             color: #c9d1d9;
         }
 
         [data-theme="dark"] .btn-outline-secondary .bi {
             color: #c9d1d9;
         }
 
         /* Empty state icons */
         [data-theme="dark"] .bi {
            filter: none;
        }
        
        /* Text-primary no dark mode */
        [data-theme="dark"] .text-primary {
            color: #58a6ff !important;
        }
        
        /* Text-secondary no dark mode */
        [data-theme="dark"] .text-secondary {
            color: #8b949e !important;
        }
        
        /* Text-success no dark mode */
        [data-theme="dark"] .text-success {
            color: #3fb950 !important;
        }
        
        /* Text-danger no dark mode */
        [data-theme="dark"] .text-danger {
            color: #f85149 !important;
        }
        
        /* Text-warning no dark mode */
        [data-theme="dark"] .text-warning {
            color: #f59e0b !important;
        }
        
        /* Text-info no dark mode */
        [data-theme="dark"] .text-info {
            color: #58a6ff !important;
        }
        
        /* Background badges no dark mode */
        [data-theme="dark"] .badge.bg-light {
            background-color: #30363d !important;
            color: #c9d1d9 !important;
        }
        
        [data-theme="dark"] .badge.bg-warning {
            background-color: #d29922 !important;
            color: #0d1117 !important;
        }
        
        [data-theme="dark"] .badge.bg-danger {
            background-color: #da3633 !important;
            color: #fff !important;
        }
        
        [data-theme="dark"] .badge.bg-success {
            background-color: #238636 !important;
            color: #fff !important;
        }
        
        [data-theme="dark"] .badge.bg-primary {
            background-color: #30363d !important;
            color: #58a6ff !important;
            border: 1px solid #58a6ff !important;
        }
        
        [data-theme="dark"] .badge.bg-info {
            background-color: #30363d !important;
            color: #58a6ff !important;
            border: 1px solid #58a6ff !important;
        }
        
        [data-theme="dark"] .badge.bg-secondary {
            background-color: #6e7681 !important;
            color: #fff !important;
        }
        
        [data-theme="dark"] .badge.text-dark {
            color: #fff !important;
        }
        
        /* Forms inline labels */
        [data-theme="dark"] label {
            color: #c9d1d9;
        }
        
        [data-theme="dark"] .form-label {
            color: #c9d1d9;
        }
        
        [data-theme="dark"] .form-text {
            color: #8b949e !important;
        }
        
        [data-theme="dark"] .form-check-label {
            color: #c9d1d9;
        }
        
        [data-theme="dark"] .form-check-input {
            background-color: #0d1117;
            border-color: #30363d;
        }
        
        [data-theme="dark"] .form-check-input:checked {
            background-color: #1d4ed8;
            border-color: #1d4ed8;
        }
        
        [data-theme="dark"] .input-group-text {
            background-color: #0d1117;
            border-color: #30363d;
            color: #c9d1d9;
        }
        
        /* Small text */
        [data-theme="dark"] small:not(.text-muted) {
            color: #c9d1d9;
        }
        
        /* Progress bars */
        [data-theme="dark"] .progress {
            background-color: #30363d;
        }
        
        /* Pagination */
        [data-theme="dark"] .pagination .page-link {
            background-color: #161b22;
            border-color: #30363d;
            color: #58a6ff;
        }
        
        [data-theme="dark"] .pagination .page-link:hover {
            background-color: #30363d;
            border-color: #30363d;
            color: #79c0ff;
        }
        
        [data-theme="dark"] .pagination .page-item.active .page-link {
            background-color: #1d4ed8;
            border-color: #1d4ed8;
        }
        
        [data-theme="dark"] .pagination .page-item.disabled .page-link {
            background-color: #0d1117;
            border-color: #30363d;
            color: #6e7681;
        }

        [data-theme="dark"] .table-danger,
        [data-theme="dark"] .table-danger > th,
        [data-theme="dark"] .table-danger > td {
            background-color: rgba(248, 81, 73, 0.1) !important;
            border-color: #da3633 !important;
            color: #ff7b72;
        }

        [data-theme="dark"] .table-warning,
        [data-theme="dark"] .table-warning > th,
        [data-theme="dark"] .table-warning > td {
            background-color: rgba(255, 191, 0, 0.1) !important;
            border-color: #d29922 !important;
            color: #ffc66d;
        }
        
        /* Sidebar mobile: dropdown que sai do header - ULTRA FAST - v4.2 - 15/10/2025 09:30 */
        @media (max-width: 767.98px) {
            .sidebar,
            #sidebarMenu {
                position: fixed !important;
                top: 48px !important; /* Começa exatamente abaixo do header */
                bottom: auto !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                height: auto !important;
                z-index: 1040 !important;
                box-shadow: none !important;
                transform: translateY(-100%) !important; /* Esconde para cima (100% da própria altura) */
                transform-origin: top !important; /* Animação começa do topo */
                transition: transform 0.08s ease-out !important; /* ULTRA RÁPIDO */
                padding-top: 0 !important;
                padding: 0 !important;
                margin-top: 0 !important;
                border-top: 2px solid rgba(0, 0, 0, 0.15) !important; /* Linha de separação do header */
                border-bottom-left-radius: 8px !important;
                border-bottom-right-radius: 8px !important;
                overflow: hidden !important; /* Importante para a animação suave */
            }
            
            [data-theme="dark"] .sidebar,
            [data-theme="dark"] #sidebarMenu {
                border-top: 2px solid rgba(255, 255, 255, 0.15) !important;
            }
            
            .sidebar.show,
            #sidebarMenu.show {
                transform: translateY(0) !important; /* Desce para posição normal (logo abaixo do header em top: 48px) */
                box-shadow: 
                    inset 0 1px 3px rgba(0, 0, 0, 0.08), /* Sombra interna sutil no topo */
                    0 4px 12px rgba(0, 0, 0, 0.25) !important; /* Sombra externa suave */
            }
            
            [data-theme="dark"] .sidebar.show,
            [data-theme="dark"] #sidebarMenu.show {
                box-shadow: 
                    inset 0 1px 4px rgba(0, 0, 0, 0.4), /* Sombra interna no dark mode */
                    0 6px 16px rgba(0, 0, 0, 0.6) !important; /* Sombra externa no dark mode */
            }
            
            .sidebar .position-sticky,
            #sidebarMenu .position-sticky {
                position: relative !important; /* Remove sticky em mobile */
                padding-top: 0 !important;
                height: auto !important; /* Altura baseada no conteúdo */
            }
            
            .sidebar .nav.flex-column,
            #sidebarMenu .nav.flex-column {
                margin-top: 0 !important;
                padding-top: 0.25rem !important; /* Pequeno espaço no topo */
                padding-bottom: 0.5rem !important; /* Pequeno espaço no final */
            }
            
            .sidebar .nav-item:first-child,
            #sidebarMenu .nav-item:first-child {
                margin-top: 0 !important;
            }
            
            /* Backdrop semi-transparente */
            .sidebar-backdrop {
                position: fixed;
                top: 48px;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 1039;
                display: none;
            }
            
            .sidebar-backdrop.show {
                display: block;
            }
            
            [data-theme="dark"] .sidebar-backdrop.show {
                background-color: rgba(0, 0, 0, 0.7);
            }
        }
    </style>
</head>
<body>
    <header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3 fs-6" href="{% url 'inventario:dashboard' %}">
            Stoke
        </a>
        <div class="d-flex align-items-center">
            <button id="help-toggle" class="btn btn-sm me-2" title="Recursos e Ajuda" data-bs-toggle="modal" data-bs-target="#helpModal">
                <i class="bi bi-question-circle-fill"></i>
            </button>
            <button id="theme-toggle" class="btn btn-sm me-2" title="Alternar tema">
                <i class="bi bi-moon-stars-fill" id="theme-icon"></i>
            </button>
            <button class="navbar-toggler d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </header>

    <!-- Backdrop para menu mobile -->
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>
    
    <!-- Modal de Recursos e Ajuda -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalLabel">
                        <i class="bi bi-info-circle-fill text-primary"></i> Recursos e Funcionalidades
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <p class="lead">
                        Bem-vindo ao <strong>Stoke</strong>! Um sistema completo de gestão de estoque com controle FIFO, análise de tendências e previsão inteligente.
                    </p>
                    
                    <hr class="my-3">
                    
                    <!-- 1. VISÃO GERAL -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-primary">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </h6>
                        <p class="mb-2">Visão geral do seu negócio com métricas em tempo real:</p>
                        <ul class="small mb-0">
                            <li><strong>Cards de resumo:</strong> Vendas do período, lucro total, margem média e produtos críticos</li>
                            <li><strong>Heatmap de lucros:</strong> Visualização de lucratividade diária nos últimos 365 dias com correção de timezone</li>
                            <li><strong>Gráfico de evolução:</strong> Acompanhe receitas, custos e lucros ao longo do tempo</li>
                            <li><strong>Produtos mais vendidos:</strong> Rankings com quantidade e links diretos</li>
                            <li><strong>Produtos mais lucrativos:</strong> Análise de margem de lucro percentual e valor absoluto</li>
                            <li><strong>Estoque baixo:</strong> Alertas automáticos com links rápidos</li>
                            <li><strong>Produtos parados:</strong> Identifique itens sem movimentação (período configurável)</li>
                            <li><strong>Filtros inteligentes:</strong> 7 dias, 30 dias, mês atual/anterior, ano atual ou período personalizado</li>
                        </ul>
                    </div>
                    
                    <hr class="my-2">
                    <small class="text-muted fw-bold">GESTÃO DE ESTOQUE</small>
                    <hr class="my-2">
                    
                    <!-- 2. PRODUTOS -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-success">
                            <i class="bi bi-box-seam"></i> Produtos
                        </h6>
                        <p class="mb-2">Controle completo do seu inventário atual:</p>
                        <ul class="small mb-0">
                            <li><strong>Sistema FIFO:</strong> Controle automático de lotes com regra "Primeiro que Entra, Primeiro que Sai"</li>
                            <li><strong>Cadastro inteligente:</strong> Detecção automática de produtos duplicados com sugestão de adicionar lote</li>
                            <li><strong>Autocomplete:</strong> Sugestões em tempo real ao digitar nomes de produtos</li>
                            <li><strong>Capitalização automática:</strong> Nomes de produtos sempre com primeira letra maiúscula</li>
                            <li><strong>Rastreabilidade completa:</strong> Cada lote possui data de entrada, fornecedor e preço individual</li>
                            <li><strong>Histórico detalhado:</strong> Veja todas as entradas, vendas e devoluções de cada produto</li>
                            <li><strong>Ajuste de estoque:</strong> Edite quantidades diretamente respeitando FIFO</li>
                            <li><strong>Status de produtos:</strong> Ative, pause ou exclua produtos permanentemente</li>
                            <li><strong>Busca avançada:</strong> Filtros por nome, status, estoque e outros critérios</li>
                            <li><strong>Cards compactos mobile:</strong> Layout otimizado com 40% mais produtos visíveis por tela</li>
                        </ul>
                    </div>
                    
                    <!-- 3. CHEGANDO -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-warning">
                            <i class="bi bi-hourglass-split"></i> Chegando
                        </h6>
                        <p class="mb-2">Pré-cadastre produtos antes de receberem:</p>
                        <ul class="small mb-0">
                            <li><strong>Cadastro rápido:</strong> Apenas nome, quantidade e preço de compra obrigatórios</li>
                            <li><strong>Autocomplete inteligente:</strong> Vincula automaticamente a produtos existentes</li>
                            <li><strong>Fornecedor opcional:</strong> Cadastre o fornecedor antecipadamente</li>
                            <li><strong>Previsão de chegada:</strong> Acompanhe datas esperadas de recebimento</li>
                            <li><strong>Conversão automática:</strong> Transforma em estoque real com um clique</li>
                            <li><strong>Detecção de duplicatas:</strong> Evita cadastros duplicados vinculando ao existente</li>
                            <li><strong>Badge de quantidade:</strong> Veja produtos "Chegando" nas listagens de estoque</li>
                            <li><strong>Cards compactos mobile:</strong> 45% mais produtos visíveis por tela</li>
                        </ul>
                    </div>
                    
                    <hr class="my-2">
                    <small class="text-muted fw-bold">OPERAÇÕES DE VENDA</small>
                    <hr class="my-2">
                    
                    <!-- 4. VENDAS -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-info">
                            <i class="bi bi-cart4"></i> Vendas
                        </h6>
                        <p class="mb-2">Registre e acompanhe suas vendas com precisão:</p>
                        <ul class="small mb-0">
                            <li><strong>Interface otimizada:</strong> Cadastro rápido com busca de produtos em tempo real</li>
                            <li><strong>Múltiplos itens:</strong> Adicione vários produtos em uma única venda</li>
                            <li><strong>Tipos de venda:</strong> Diferencie vendas na "Loja" (50% lucro) e "Externa" (100% lucro)</li>
                            <li><strong>Sistema de brindes:</strong> Marque itens como cortesia sem cobrar (rastreamento separado)</li>
                            <li><strong>Descontos flexíveis:</strong> Aplique descontos gerais na venda</li>
                            <li><strong>Capitalização automática:</strong> Nomes de clientes sempre formatados corretamente</li>
                            <li><strong>Baixa FIFO automática:</strong> Sistema consome do lote mais antigo</li>
                            <li><strong>Cálculo de lucro:</strong> Margem e lucro calculados automaticamente por item e total</li>
                            <li><strong>Histórico completo:</strong> Filtre por ID, cliente, tipo, data ou produto</li>
                            <li><strong>Badges informativos:</strong> Indicadores de devoluções totais, parciais e brindes</li>
                            <li><strong>Cards mobile ultra-compactos:</strong> 50% mais vendas visíveis por tela</li>
                        </ul>
                    </div>
                    
                    <!-- 5. DEVOLUÇÕES -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-danger">
                            <i class="bi bi-arrow-return-left"></i> Devoluções
                        </h6>
                        <p class="mb-2">Gerencie devoluções com rastreabilidade completa:</p>
                        <ul class="small mb-0">
                            <li><strong>Vinculação automática:</strong> Devoluções conectadas à venda original</li>
                            <li><strong>Devolução parcial:</strong> Devolva apenas alguns itens ou quantidades de uma venda</li>
                            <li><strong>Devolução total:</strong> Cancele vendas completas quando necessário</li>
                            <li><strong>Reintegração ao estoque:</strong> Escolha se produtos voltam ao inventário</li>
                            <li><strong>Rastreabilidade:</strong> Data de retorno ao estoque registrada automaticamente</li>
                            <li><strong>Impacto no lucro:</strong> Ajustes automáticos nos cálculos de margem</li>
                            <li><strong>Histórico completo:</strong> Consulte todas as devoluções com filtros</li>
                            <li><strong>Cards compactos mobile:</strong> 55% mais devoluções visíveis por tela</li>
                        </ul>
                    </div>
                    
                    <hr class="my-2">
                    <small class="text-muted fw-bold">INTELIGÊNCIA E PLANEJAMENTO</small>
                    <hr class="my-2">
                    
                    <!-- 6. ANÁLISE DE TENDÊNCIAS -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-purple">
                            <i class="bi bi-graph-up-arrow"></i> Análise de Tendências
                        </h6>
                        <p class="mb-2">Inteligência para reposição otimizada:</p>
                        <ul class="small mb-0">
                            <li><strong>Média móvel inteligente:</strong> Calcula consumo diário baseado em histórico configurável</li>
                            <li><strong>Análise de tendências:</strong> Detecta se vendas estão crescendo, estáveis ou declinando</li>
                            <li><strong>Ponto de reposição:</strong> Calcula automaticamente quando comprar baseado em lead time</li>
                            <li><strong>Dias de cobertura:</strong> Mostra quantos dias o estoque atual durará</li>
                            <li><strong>Urgência inteligente:</strong> Classifica produtos em ALTA, MÉDIA, BAIXA ou OK</li>
                            <li><strong>Quantidade sugerida:</strong> Calcula exatamente quantas unidades comprar</li>
                            <li><strong>Custo de reposição:</strong> Estima valor total necessário para reabastecimento</li>
                            <li><strong>Filtros avançados:</strong> Por nome, urgência e tendência</li>
                            <li><strong>Configurável:</strong> Ajuste dias de análise, lead time e cobertura mínima por produto</li>
                        </ul>
                    </div>
                    
                    <hr class="my-2">
                    <small class="text-muted fw-bold">SISTEMA</small>
                    <hr class="my-2">
                    
                    <!-- 7. CONFIGURAÇÕES -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-secondary">
                            <i class="bi bi-gear"></i> Configurações
                        </h6>
                        <p class="mb-2">Personalize o sistema conforme suas necessidades:</p>
                        <ul class="small mb-0">
                            <li><strong>Fornecedores:</strong> Cadastro com modal rápido em qualquer tela</li>
                            <li><strong>Capitalização automática:</strong> Nomes de fornecedores sempre formatados</li>
                            <li><strong>Nome da empresa:</strong> Personalize identificação no sistema</li>
                            <li><strong>Limite de estoque baixo:</strong> Configure threshold de alertas</li>
                            <li><strong>Margem de lucro ideal:</strong> Defina meta de lucratividade</li>
                            <li><strong>Dias de produto parado:</strong> Configure período de inatividade (padrão: 30 dias)</li>
                            <li><strong>Dias de análise de tendências:</strong> Ajuste janela de histórico (7-365 dias)</li>
                        </ul>
                    </div>
                    
                    <!-- 8. DARK MODE -->
                    <div class="mb-4">
                        <h6 class="fw-bold">
                            <i class="bi bi-moon-stars-fill"></i> Modo Escuro
                        </h6>
                        <p class="mb-2">Proteja seus olhos em ambientes com pouca luz:</p>
                        <ul class="small mb-0">
                            <li><strong>Toggle rápido:</strong> Clique no botão <i class="bi bi-moon-stars-fill"></i> no canto superior direito</li>
                            <li><strong>Atalho de teclado:</strong> Pressione <kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>D</kbd></li>
                            <li><strong>Cores otimizadas:</strong> Paleta cuidadosamente ajustada para conforto visual</li>
                            <li><strong>Persistente:</strong> Sua preferência é salva automaticamente no navegador</li>
                            <li><strong>Consistência total:</strong> Todos os elementos respeitam o tema escolhido</li>
                        </ul>
                    </div>
                    
                    <hr class="my-3">
                    
                    <!-- DICAS IMPORTANTES -->
                    <div class="alert alert-info mb-0">
                        <h6 class="alert-heading">
                            <i class="bi bi-lightbulb-fill"></i> Dicas e Boas Práticas
                        </h6>
                        <ul class="small mb-0">
                            <li><strong>FIFO Automático:</strong> O sistema sempre consome do lote mais antigo ao realizar vendas</li>
                            <li><strong>Capitalização:</strong> Nomes de produtos, clientes e fornecedores são automaticamente formatados (primeira letra maiúscula)</li>
                            <li><strong>Análise de Tendências:</strong> Requer no mínimo 14 dias de histórico de vendas para análise confiável</li>
                            <li><strong>Timezone Correto:</strong> Todo o sistema usa timezone local (não UTC) para cálculos precisos</li>
                            <li><strong>Cards Compactos:</strong> Em mobile, todas as listagens usam layout ultra-otimizado para máxima densidade de informação</li>
                            <li><strong>Busca Inteligente:</strong> Use autocomplete para evitar duplicatas e acelerar cadastros</li>
                            <li><strong>Mobile Friendly:</strong> Sistema 100% responsivo, otimizado para tablets e smartphones</li>
                            <li><strong>Design Consistente:</strong> Todas as páginas seguem o mesmo padrão visual (Design System)</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky">
                    <ul class="nav flex-column">
                        <!-- Visão Geral -->
                        <li class="nav-item">
                            <a href="{% url 'inventario:dashboard' %}" class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" aria-current="page">
                                <i class="bi bi-speedometer2"></i> Dashboard
                            </a>
                        </li>
                        
                        <!-- Gestão de Estoque -->
                        <li class="nav-item">
                            <a href="{% url 'inventario:listar_produtos' %}" class="nav-link {% if 'produto' in request.resolver_match.url_name or 'adicionar_estoque' in request.resolver_match.url_name %}active{% endif %}">
                                <i class="bi bi-box-seam"></i> Produtos
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if 'chegando' in request.resolver_match.url_name or 'incluir_no_estoque' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'inventario:listar_produtos_chegando' %}">
                                <i class="bi bi-hourglass-split"></i> Chegando
                            </a>
                        </li>
                        
                        <!-- Operações de Venda -->
                        <li class="nav-item">
                            <a class="nav-link {% if 'venda' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'inventario:listar_vendas' %}">
                                <i class="bi bi-cart4"></i> Vendas
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if 'devolucao' in request.resolver_match.url_name %}active{% endif %}" href="{% url 'inventario:listar_devolucoes' %}">
                                <i class="bi bi-arrow-return-left"></i> Devoluções
                            </a>
                        </li>
                        
                        <!-- Inteligência e Planejamento -->
                        <li class="nav-item">
                            <a class="nav-link {% if request.resolver_match.url_name == 'analise_tendencias' %}active{% endif %}" href="{% url 'inventario:analise_tendencias' %}">
                                <i class="bi bi-graph-up-arrow"></i> Análise de Tendências
                            </a>
                        </li>
                        
                        <!-- Sistema -->
                        <li class="nav-item">
                            <a href="{% url 'inventario:configuracoes' %}" class="nav-link {% if request.resolver_match.url_name == 'configuracoes' %}active{% endif %}">
                                <i class="bi bi-gear"></i> Configurações
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="pt-3 pb-2 mb-3">
                    {% block content %}{% endblock %}
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        // Registrar Service Worker (PWA)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('{% url "inventario:service_worker" %}');
            });
        }
    </script>
    
    <!-- Dark Mode Toggle Script -->
    <script>
        // Sistema de Dark Mode
        (function() {
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');
            const html = document.documentElement;
            
            // Aplicar tema e salvar
            function setTheme(theme) {
                html.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                updateIcon(theme);
                
                // Atualizar cores dos gráficos se existir
                if (typeof window.updateLineChartColors === 'function') {
                    window.updateLineChartColors();
                }
            }
            
            // Atualizar ícone do botão
            function updateIcon(theme) {
                if (theme === 'dark') {
                    themeIcon.className = 'bi bi-sun-fill';
                } else {
                    themeIcon.className = 'bi bi-moon-stars-fill';
                }
            }
            
            // Função para obter cores baseadas no tema (acessível globalmente)
            window.getChartColors = function() {
                const isDark = html.getAttribute('data-theme') === 'dark';
                return {
                    isDark: isDark,
                    gridColor: isDark ? '#30363d' : 'rgba(0, 0, 0, 0.1)',
                    textColor: isDark ? '#c9d1d9' : '#000',
                    backgroundColor: isDark ? '#161b22' : '#fff'
                };
            };
            
            // Toggle entre temas
            function toggleTheme() {
                const currentTheme = html.getAttribute('data-theme') || 'light';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                setTheme(newTheme);
            }
            
            // Apenas atualiza o ícone baseado no tema JÁ APLICADO no <head>
            const currentTheme = html.getAttribute('data-theme') || 'light';
            updateIcon(currentTheme);
            
            // Event listener no botão
            themeToggle.addEventListener('click', toggleTheme);
            
            // Atalho de teclado: Ctrl+Shift+D para toggle
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                    e.preventDefault();
                    toggleTheme();
                }
            });
            
            // Detectar mudanças na preferência do sistema
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                const newTheme = e.matches ? 'dark' : 'light';
                setTheme(newTheme);
            });
        })();
    </script>
    
    <!-- Script de controle do menu mobile -->
    <script>
        (function() {
            const sidebarMenu = document.getElementById('sidebarMenu');
            const sidebarBackdrop = document.getElementById('sidebarBackdrop');
            
            // Controla abertura/fechamento do menu mobile
            if (sidebarMenu && sidebarBackdrop) {
                // Quando o Bootstrap abre/fecha o menu
                sidebarMenu.addEventListener('show.bs.collapse', function() {
                    sidebarBackdrop.classList.add('show');
                });
                
                sidebarMenu.addEventListener('hide.bs.collapse', function() {
                    sidebarBackdrop.classList.remove('show');
                });
                
                // Clicar no backdrop fecha o menu
                sidebarBackdrop.addEventListener('click', function() {
                    const bsCollapse = bootstrap.Collapse.getInstance(sidebarMenu);
                    if (bsCollapse) {
                        bsCollapse.hide();
                    }
                });
                
                // Clicar em qualquer link do menu fecha o menu no mobile
                const menuLinks = sidebarMenu.querySelectorAll('.nav-link');
                menuLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        // Só fecha no mobile
                        if (window.innerWidth < 768) {
                            const bsCollapse = bootstrap.Collapse.getInstance(sidebarMenu);
                            if (bsCollapse) {
                                bsCollapse.hide();
                            }
                        }
                    });
                });
            }
        })();
    </script>
    
    {% block extra_scripts %}{% endblock %}
</body>
</html> 