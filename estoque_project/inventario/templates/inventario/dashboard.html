{% extends 'inventario/base.html' %}

{% block title %}Dashboard - Gestão de Estoque{% endblock %}

{% block content %}
<div class="row align-items-center mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <h1 class="mb-0">Dashboard</h1>
            
            <!-- Formulário de Filtro de Data -->
            <form method="get" id="filtro-periodo-form">
                <select class="form-select form-select-sm" name="periodo" id="periodo-select" style="width: auto; padding-right: 0.4rem; padding-left: 0.5rem;">
                    <option value="7d" {% if periodo_selecionado == '7d' %}selected{% endif %}>7 dias</option>
                    <option value="30d" {% if periodo_selecionado == '30d' %}selected{% endif %}>30 dias</option>
                    <option value="anual" {% if periodo_selecionado == 'anual' %}selected{% endif %}>Anual</option>
                    <option value="custom" {% if periodo_selecionado == 'custom' %}selected{% endif %}>Personalizado</option>
                </select>
            </form>
        </div>
        
        <!-- Campos de data personalizada (aparecem abaixo quando selecionado) -->
        <div id="periodo-customizado" class="mt-2 {% if periodo_selecionado != 'custom' %}d-none{% endif %}">
            <form method="get" class="d-flex align-items-center gap-2 flex-wrap">
                <input type="hidden" name="periodo" value="custom">
                <input type="date" class="form-control" name="data_inicio" id="data-inicio" value="{{ data_inicio_selecionada }}" max="{{ hoje_str }}" style="width: auto;">
                <span class="text-muted">até</span>
                <input type="date" class="form-control" name="data_fim" id="data-fim" value="{{ data_fim_selecionada }}" max="{{ hoje_str }}" style="width: auto;">
                <button type="submit" class="btn btn-primary btn-sm">
                    <i class="bi bi-search"></i> Filtrar
                </button>
            </form>
        </div>
    </div>
</div>

<style>
.dashboard-card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.dashboard-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.12);
}

.card-receita {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

.card-lucro {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
}

.card-vendas {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
}

.card-estoque {
    background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
    color: white;
}

.dashboard-icon {
    font-size: 2rem;
    opacity: 1;
    margin-bottom: 0.5rem;
}

.dashboard-value {
    font-weight: 700;
    margin-bottom: 0;
    line-height: 1.2;
}

.dashboard-title {
    font-size: 0.85rem;
    font-weight: 600;
    opacity: 1;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Força texto branco nos cards no modo escuro */
[data-theme="dark"] .dashboard-card .dashboard-title,
[data-theme="dark"] .dashboard-card .dashboard-value,
[data-theme="dark"] .dashboard-card .dashboard-icon {
    color: #fff !important;
}

@media (max-width: 767.98px) {
    .dashboard-card {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
    }
    
    .dashboard-card .card-body {
        padding: 0.75rem 0.5rem;
    }
    
    .dashboard-value {
        font-size: 1.1rem !important;
        line-height: 1.1;
    }
    
    .dashboard-icon {
        font-size: 1.2rem;
        margin-bottom: 0.25rem;
    }
    
    .dashboard-title {
        font-size: 0.7rem;
        margin-bottom: 0.25rem;
        letter-spacing: 0.3px;
    }
}
</style>

<div class="row g-2 g-md-3">
    <!-- Card: Vendas Realizadas -->
    <div class="col-6 col-md-3">
        <div class="card dashboard-card card-vendas h-100">
            <div class="card-body text-center">
                <div class="dashboard-icon">
                    <i class="bi bi-bag-check-fill"></i>
                </div>
                <h6 class="dashboard-title">Vendas Realizadas</h6>
                <p class="dashboard-value fs-3">{{ numero_vendas }}</p>
            </div>
        </div>
    </div>
    
    <!-- Card: Receita Total -->
    <div class="col-6 col-md-3">
        <div class="card dashboard-card card-receita h-100">
            <div class="card-body text-center">
                <div class="dashboard-icon">
                    <i class="bi bi-graph-up-arrow"></i>
                </div>
                <h6 class="dashboard-title">Receita Total</h6>
                <p class="dashboard-value fs-3">R$ {{ receita_total|floatformat:2 }}</p>
            </div>
        </div>
    </div>
    
    <!-- Card: Seu Lucro -->
    <div class="col-6 col-md-3">
        <div class="card dashboard-card card-lucro h-100">
            <div class="card-body text-center">
                <div class="dashboard-icon">
                    <i class="bi bi-trophy-fill"></i>
                </div>
                <h6 class="dashboard-title">Seu Lucro</h6>
                <p class="dashboard-value fs-3">R$ {{ meu_lucro_total|floatformat:2 }}</p>
            </div>
        </div>
    </div>
    
    <!-- Card: Valor em Estoque -->
    <div class="col-6 col-md-3">
        <div class="card dashboard-card card-estoque h-100">
            <div class="card-body text-center">
                <div class="dashboard-icon">
                    <i class="bi bi-boxes"></i>
                </div>
                <h6 class="dashboard-title">Valor em Estoque</h6>
                <p class="dashboard-value fs-3">R$ {{ valor_total_estoque|floatformat:2 }}</p>
            </div>
        </div>
    </div>
</div>

<div class="row g-2 g-md-3 mt-2 mt-md-3">
    <!-- Coluna da Esquerda: Gráfico de Linhas -->
    <div class="col-lg-7">
        <div class="card h-100">
            <div class="card-header">
                Receita Final vs. Seu Lucro (Período Selecionado)
            </div>
            <div class="card-body">
                <canvas id="lineChart" style="min-height: 300px;"></canvas>
            </div>
        </div>
    </div>

    <!-- Coluna da Direita: Cards de Informação Rápida -->
    <div class="col-lg-5">
        <div class="row g-2 g-md-3">
            <!-- Estoque Baixo - Só aparece se houver produtos com estoque baixo -->
            {% if produtos_estoque_baixo %}
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-exclamation-triangle-fill text-danger"></i> Produtos com Estoque Baixo
                    </div>
                    <div class="card-body">
                        <table class="table table-striped table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th class="text-end">Qtd. Atual</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for produto in produtos_estoque_baixo %}
                                <tr>
                                    <td><a href="{% url 'inventario:detalhar_produto' pk=produto.pk %}">{{ produto.nome }}</a></td>
                                    <td class="text-end"><span class="badge bg-danger">{{ produto.qtd_total }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Mais Vendidos -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <i class="bi bi-trophy-fill"></i> Mais Vendidos
                    </div>
                    <div class="card-body">
                        {% if top_produtos_vendidos %}
                            <ul class="list-group list-group-flush">
                                {% for produto in top_produtos_vendidos %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                        <a href="{% url 'inventario:detalhar_produto' pk=produto.produto__id %}">{{ produto.produto__nome }}</a>
                                        <span class="badge bg-primary rounded-pill">{{ produto.quantidade_total_vendida }}</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-center text-muted mb-0">Nenhuma venda no período.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Mais Lucrativos -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <i class="bi bi-currency-dollar"></i> Mais Lucrativos
                    </div>
                    <div class="card-body">
                        {% if produtos_mais_lucrativos %}
                            <ul class="list-group list-group-flush">
                                {% for produto in produtos_mais_lucrativos %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                        <a href="{% url 'inventario:detalhar_produto' pk=produto.produto__id %}">{{ produto.produto__nome }}</a>
                                        <div class="text-end">
                                            <span class="badge bg-success">R$ {{ produto.lucro_total|floatformat:2 }}</span>
                                            <small class="d-block text-muted mt-1">{{ produto.margem_lucro|floatformat:1 }}% margem</small>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-center text-muted mb-0">Nenhuma venda no período.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Produtos Parados (Sem Vendas) - Só aparece se houver produtos parados -->
            {% if produtos_parados %}
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-clock-history text-warning"></i> Produtos Parados ({{ dias_limite_parado }}+ dias sem vender)
                    </div>
                    <div class="card-body p-2">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Produto</th>
                                        <th class="text-center">Qtd.</th>
                                        <th class="text-end">Dias Parado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in produtos_parados %}
                                    <tr>
                                        <td><a href="{% url 'inventario:detalhar_produto' pk=item.produto.pk %}">{{ item.produto.nome }}</a></td>
                                        <td class="text-center"><span class="badge bg-secondary">{{ item.quantidade }}</span></td>
                                        <td class="text-end">
                                            <span class="badge bg-warning text-dark">{{ item.dias_parado }} dias</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Gráfico Heatmap (Linha Completa) -->
<div class="row mt-2 mt-md-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                Atividade de Lucro (Último Ano)
            </div>
            <div class="card-body">
                <div class="heatmap-wrapper">
                    <div id="heatmap-months-container"></div>
                    <div id="heatmap-container" class="heatmap-loading"></div>
                </div>
                <div class="d-flex justify-content-end align-items-center mt-2">
                    <small class="me-2 text-muted">Menos</small>
                    <div class="heatmap-legend-cell" data-level="0"></div>
                    <div class="heatmap-legend-cell" data-level="1"></div>
                    <div class="heatmap-legend-cell" data-level="2"></div>
                    <div class="heatmap-legend-cell" data-level="3"></div>
                    <div class="heatmap-legend-cell" data-level="4"></div>
                    <small class="ms-2">Mais</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dados JSON para o JavaScript -->
<script type="application/json" id="heatmap-data-json">{{ heatmap_data|safe }}</script>
<script type="application/json" id="line-chart-data-json">
{
    "labels": {{ labels_grafico|safe }},
    "receita": {{ receita_grafico|safe }},
    "lucro": {{ meu_lucro_grafico|safe }}
}
</script>

{% endblock %}

{% block extra_head %}
<style>
/* Estilos para o Heatmap */
.heatmap-wrapper {
    overflow-x: auto;
    padding-bottom: 10px;
    -webkit-overflow-scrolling: touch; /* Scroll suave em iOS */
    scroll-behavior: smooth; /* Scroll suave em outros browsers */
}

@media (max-width: 767.98px) {
    .heatmap-wrapper {
        /* Em mobile, garantir que o scroll funcione bem */
        scroll-snap-type: x proximity;
        scrollbar-width: thin;
    }
    
    .heatmap-wrapper::-webkit-scrollbar {
        height: 6px;
    }
    
    .heatmap-wrapper::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
    }
    
    [data-theme="dark"] .heatmap-wrapper::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.2);
    }
}
#heatmap-container {
    display: grid;
    grid-template-columns: repeat(53, 1fr);
    grid-template-rows: repeat(7, 1fr);
    grid-auto-flow: column;
    gap: 3px;
    min-width: 800px; /* Garante que o heatmap não seja espremido */
}
.heatmap-cell {
    width: 100%;
    aspect-ratio: 1 / 1;
    background-color: #ebedf0;
    border-radius: 2px;
}
.heatmap-cell[data-level="1"] { background-color: #9be9a8; }
.heatmap-cell[data-level="2"] { background-color: #40c463; }
.heatmap-cell[data-level="3"] { background-color: #30a14e; }
.heatmap-cell[data-level="4"] { background-color: #216e39; }

/* Heatmap Legend Cells */
.heatmap-legend-cell {
    width: 12px;
    height: 12px;
    margin: 0 2px;
    border-radius: 2px;
}
.heatmap-legend-cell[data-level="0"] { background-color: #ebedf0; }
.heatmap-legend-cell[data-level="1"] { background-color: #9be9a8; }
.heatmap-legend-cell[data-level="2"] { background-color: #40c463; }
.heatmap-legend-cell[data-level="3"] { background-color: #30a14e; }
.heatmap-legend-cell[data-level="4"] { background-color: #216e39; }

/* Dark mode heatmap legend */
[data-theme="dark"] .heatmap-legend-cell[data-level="0"] { background-color: #161b22; border: 1px solid #30363d; }
[data-theme="dark"] .heatmap-legend-cell[data-level="1"] { background-color: rgba(88, 166, 255, 0.2); }
[data-theme="dark"] .heatmap-legend-cell[data-level="2"] { background-color: rgba(88, 166, 255, 0.4); }
[data-theme="dark"] .heatmap-legend-cell[data-level="3"] { background-color: rgba(88, 166, 255, 0.6); }
[data-theme="dark"] .heatmap-legend-cell[data-level="4"] { background-color: rgba(88, 166, 255, 0.8); }

.heatmap-loading {
    height: 150px; /* Altura enquanto carrega */
    background-color: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
}

[data-theme="dark"] .heatmap-loading {
    background-color: #0d1117;
    color: #6e7681;
}

#heatmap-months-container {
    display: grid;
    grid-template-columns: repeat(53, 1fr);
    gap: 3px;
    margin-bottom: 5px;
    font-size: 0.7rem;
    color: #555;
    min-width: 800px; /* Alinhado com o container do heatmap */
}

[data-theme="dark"] #heatmap-months-container {
    color: #8b949e;
}

.heatmap-month-label {
    grid-column: span 4;
    text-align: left;
    white-space: nowrap;
}

.heatmap-legend-cell {
    width: 15px;
    height: 15px;
    border-radius: 2px;
    margin: 0 2px;
}
</style>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const periodoSelect = document.getElementById('periodo-select');
    const customizadoDiv = document.getElementById('periodo-customizado');
    const form = document.getElementById('filtro-periodo-form');

    // Auto-submit quando o período for alterado
    periodoSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
            // Mostra os campos de data personalizada
            customizadoDiv.classList.remove('d-none');
        } else {
            // Esconde os campos e submete o form
            customizadoDiv.classList.add('d-none');
            form.submit(); // Auto-submit para períodos pré-definidos
        }
    });

    // --- GRÁFICO DE LINHAS ---
    let lineChart = null;
    try {
        const lineChartData = JSON.parse(document.getElementById('line-chart-data-json').textContent);
        const ctx = document.getElementById('lineChart');
        if (ctx) {
            // Função para obter configuração do gráfico com cores atualizadas
            function getLineChartConfig() {
                const chartColors = window.getChartColors();
                return {
                    type: 'line',
                    data: {
                        labels: lineChartData.labels,
                        datasets: [
                            { label: 'Receita Final', data: lineChartData.receita, borderColor: 'rgb(75, 192, 192)', backgroundColor: 'rgba(75, 192, 192, 0.2)', fill: true, tension: 0.1 },
                            { label: 'Seu Lucro', data: lineChartData.lucro, borderColor: 'rgb(54, 162, 235)', backgroundColor: 'rgba(54, 162, 235, 0.2)', fill: true, tension: 0.1 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { 
                            y: { 
                                beginAtZero: true,
                                grid: { color: chartColors.gridColor },
                                ticks: { color: chartColors.textColor }
                            },
                            x: {
                                grid: { color: chartColors.gridColor },
                                ticks: { color: chartColors.textColor }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: { color: chartColors.textColor }
                            }
                        }
                    }
                };
            }
            
            // Criar gráfico inicial
            lineChart = new Chart(ctx, getLineChartConfig());
            
            // Função para atualizar cores do gráfico
            window.updateLineChartColors = function() {
                if (lineChart) {
                    const chartColors = window.getChartColors();
                    lineChart.options.scales.y.grid.color = chartColors.gridColor;
                    lineChart.options.scales.y.ticks.color = chartColors.textColor;
                    lineChart.options.scales.x.grid.color = chartColors.gridColor;
                    lineChart.options.scales.x.ticks.color = chartColors.textColor;
                    lineChart.options.plugins.legend.labels.color = chartColors.textColor;
                    lineChart.update();
                }
            };
        }
    } catch (e) {
        console.error("Erro ao renderizar o gráfico de linhas:", e);
    }

    // --- GRÁFICO HEATMAP ---
    try {
        const heatmapContainer = document.getElementById('heatmap-container');
        const heatmapMonthsContainer = document.getElementById('heatmap-months-container');
        if (heatmapContainer && heatmapMonthsContainer) {
            const heatmapData = JSON.parse(document.getElementById('heatmap-data-json').textContent);
            const cores = ['#ebedf0', '#9be9a8', '#40c463', '#30a14e', '#216e39'];
            
            heatmapContainer.innerHTML = '';
            heatmapContainer.classList.remove('heatmap-loading');
            
            const monthNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
            let lastMonth = -1;

            heatmapData.forEach((item, index) => {
                const diaEl = document.createElement('div');
                diaEl.classList.add('heatmap-cell');
                diaEl.style.backgroundColor = cores[item.nivel];
                
                const dataObj = new Date(item.data);
                const dataFormatada = new Date(dataObj.getUTCFullYear(), dataObj.getUTCMonth(), dataObj.getUTCDate()).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const lucroFormatado = `R$ ${item.lucro.toFixed(2).replace('.', ',')}`;
                
                diaEl.setAttribute('data-bs-toggle', 'tooltip');
                diaEl.setAttribute('data-bs-placement', 'top');
                diaEl.setAttribute('title', `${dataFormatada} - Lucro: ${lucroFormatado}`);
                
                heatmapContainer.appendChild(diaEl);

                // Adiciona a marcação do mês quando ele muda
                const date = new Date(item.data);
                const correctedDate = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                const month = correctedDate.getUTCMonth();

                if (month !== lastMonth) {
                    lastMonth = month;
                    const colIndex = Math.floor(index / 7);
                    
                    const monthEl = document.createElement('div');
                    monthEl.className = 'heatmap-month-label';
                    monthEl.textContent = monthNames[month];
                    monthEl.style.gridColumnStart = colIndex + 1;
                    heatmapMonthsContainer.appendChild(monthEl);
                }
            });

            const tooltipTriggerList = Array.from(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.forEach(tooltipTriggerEl => {
                new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Auto-scroll para a direita (dias mais recentes)
            const heatmapWrapper = document.querySelector('.heatmap-wrapper');
            if (heatmapWrapper) {
                // Função para posicionar no final (dias mais recentes)
                const scrollToEnd = () => {
                    heatmapWrapper.scrollLeft = heatmapWrapper.scrollWidth - heatmapWrapper.clientWidth;
                };
                
                // Executa o scroll imediatamente
                scrollToEnd();
                
                // Em telas pequenas, executa novamente após um delay para garantir que o layout esteja completo
                if (window.innerWidth < 768) {
                    setTimeout(scrollToEnd, 100);
                    setTimeout(scrollToEnd, 300);
                }
                
                // Também executa após o redimensionamento da janela
                const resizeObserver = new ResizeObserver(() => {
                    setTimeout(scrollToEnd, 50);
                });
                resizeObserver.observe(heatmapWrapper);
            }
        }
    } catch (e) {
        console.error("Erro ao renderizar o heatmap:", e);
    }
});
</script>
{% endblock %} 