{% extends 'inventario/base.html' %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<!-- Cabeçalho Responsivo -->
<div class="row align-items-center mb-4">
    <div class="col-12 col-md-6 mb-2 mb-md-0">
        <h1 class="mb-0">{{ titulo }}</h1>
    </div>
    <div class="col-12 col-md-6">
        <div class="d-flex flex-wrap gap-2 justify-content-md-end">
            {% if status_atual == 'ativos' %}
                <a href="{% url 'inventario:listar_produtos' %}?status=pausados&q={{ query_atual|urlencode }}" class="btn btn-secondary">
                    <i class="bi bi-pause-circle"></i> <span class="d-none d-sm-inline">Ver</span> Pausados
                </a>
            {% else %}
                <a href="{% url 'inventario:listar_produtos' %}?q={{ query_atual|urlencode }}" class="btn btn-secondary">
                    <i class="bi bi-play-circle"></i> <span class="d-none d-sm-inline">Ver</span> Ativos
                </a>
            {% endif %}
            <a href="{% url 'inventario:criar_produto' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> <span class="d-none d-sm-inline">Novo</span> Produto
            </a>
        </div>
    </div>
</div>

<!-- Busca -->
<div class="card mb-3">
    <div class="card-body py-3">
        <form method="get">
            <input type="hidden" name="status" value="{{ status_atual }}">
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" placeholder="Buscar produto por nome..." name="q" value="{{ query_atual }}" id="search-input">
                {% if query_atual %}
                    <a href="{% url 'inventario:listar_produtos' %}?status={{ status_atual }}" class="btn btn-outline-secondary">
                        <i class="bi bi-x"></i>
                    </a>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<!-- Mensagens -->
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
{% endif %}

<!-- Tabela para Desktop/Tablet -->
<div class="card d-none d-lg-block">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Nome do Produto</th>
                        <th class="text-center">Estoque</th>
                        <th class="text-center">Chegando</th>
                        <th class="text-end">Preço Venda</th>
                        <th class="text-end">Custo Médio</th>
                        <th class="text-center">Margem</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody id="produtos-tbody-desktop">
                    {% for produto in produtos %}
                        <tr class="align-middle">
                            <td>
                                <a href="{% url 'inventario:detalhar_produto' pk=produto.pk %}" class="fw-semibold text-decoration-none">
                                    {{ produto.nome }}
                                </a>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-primary">{{ produto.quantidade_total_agg|default:"0" }}</span>
                            </td>
                            <td class="text-center">
                                {% with chegando=produto.quantidade_chegando|default:0 %}
                                    {% if chegando > 0 %}
                                        <span class="badge bg-info text-dark">{{ chegando }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">0</span>
                                    {% endif %}
                                {% endwith %}
                            </td>
                            <td class="text-end fw-bold">R$ {{ produto.preco_venda|floatformat:2 }}</td>
                            <td class="text-end">R$ {{ produto.custo_medio_ponderado_agg|floatformat:2|default:"0.00" }}</td>
                            <td class="text-center">
                                {% if produto.margem_lucro_agg is not None %}
                                    <span class="badge {% if config and produto.margem_lucro_agg < config.margem_lucro_ideal %}bg-danger{% else %}bg-success{% endif %}">
                                        {{ produto.margem_lucro_agg|floatformat:2 }}%
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">N/A</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <a href="{% url 'inventario:detalhar_produto' pk=produto.pk %}" class="btn btn-sm btn-info" title="Detalhes"><i class="bi bi-eye"></i></a>
                                    <a href="{% url 'inventario:adicionar_estoque' pk=produto.pk %}" class="btn btn-sm btn-success" title="Adicionar Lote"><i class="bi bi-plus-lg"></i></a>
                                    <a href="{% url 'inventario:editar_produto' pk=produto.pk %}" class="btn btn-sm btn-warning" title="Editar"><i class="bi bi-pencil"></i></a>
                                    {% if produto.ativo %}
                                        <form action="{% url 'inventario:pausar_produto' pk=produto.pk %}" method="post" class="d-inline" onsubmit="return confirm('Tem certeza que deseja pausar este produto?');">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-secondary" title="Pausar"><i class="bi bi-pause-fill"></i></button>
                                        </form>
                                    {% else %}
                                        <form action="{% url 'inventario:reativar_produto' pk=produto.pk %}" method="post" class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-success" title="Reativar"><i class="bi bi-play-fill"></i></button>
                                        </form>
                                        <form action="{% url 'inventario:excluir_produto_permanente' pk=produto.pk %}" method="post" class="d-inline" onsubmit="return confirm('EXCLUSÃO PERMANENTE!\n\nEsta ação não pode ser desfeita. Continuar?');">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-danger" title="Excluir Permanentemente"><i class="bi bi-trash"></i></button>
                                        </form>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <i class="bi bi-inbox display-1 text-muted"></i>
                                <h5 class="text-muted mt-2">
                                    {% if query_atual %}
                                        Nenhum produto encontrado para "<strong>{{ query_atual }}</strong>"
                                    {% else %}
                                        Nenhum produto encontrado
                                    {% endif %}
                                </h5>
                                {% if not query_atual %}
                                    <a href="{% url 'inventario:criar_produto' %}" class="btn btn-primary mt-2">
                                        <i class="bi bi-plus-circle"></i> Adicionar Primeiro Produto
                                    </a>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Cards para Mobile/Tablet -->
<div class="d-lg-none" id="produtos-cards-mobile">
    {% for produto in produtos %}
        <div class="card mb-2">
            <div class="card-body py-2 px-3">
                <!-- Linha 1: Nome e Badges de Estoque -->
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <div class="flex-grow-1">
                        <h6 class="mb-0 small">
                            <a href="{% url 'inventario:detalhar_produto' pk=produto.pk %}" class="text-decoration-none">
                                <span class="fw-bold">{{ produto.nome }}</span>
                            </a>
                        </h6>
                        <small class="text-muted">Custo: R$ {{ produto.custo_medio_ponderado_agg|floatformat:2|default:"0.00" }}</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-primary">{{ produto.quantidade_total_agg|default:"0" }}</span>
                        {% with chegando=produto.quantidade_chegando|default:0 %}
                            {% if chegando > 0 %}
                                <span class="badge bg-info text-dark">+{{ chegando }}</span>
                            {% endif %}
                        {% endwith %}
                    </div>
                </div>
                
                <!-- Linha 2: Preço e Margem -->
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <div>
                        <strong class="text-primary">R$ {{ produto.preco_venda|floatformat:2 }}</strong>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">Margem:</small>
                        {% if produto.margem_lucro_agg is not None %}
                            <span class="badge {% if config and produto.margem_lucro_agg < config.margem_lucro_ideal %}bg-danger{% else %}bg-success{% endif %} ms-1">
                                {{ produto.margem_lucro_agg|floatformat:1 }}%
                            </span>
                        {% else %}
                            <span class="badge bg-secondary ms-1">N/A</span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Linha 3: Ações (ícones apenas) -->
                <div class="d-flex flex-wrap gap-1 mt-2">
                    <a href="{% url 'inventario:detalhar_produto' pk=produto.pk %}" class="btn btn-info btn-sm py-0 px-2" title="Ver detalhes">
                        <i class="bi bi-eye"></i>
                    </a>
                    <a href="{% url 'inventario:adicionar_estoque' pk=produto.pk %}" class="btn btn-success btn-sm py-0 px-2" title="Adicionar lote">
                        <i class="bi bi-plus-lg"></i>
                    </a>
                    <a href="{% url 'inventario:editar_produto' pk=produto.pk %}" class="btn btn-warning btn-sm py-0 px-2" title="Editar">
                        <i class="bi bi-pencil"></i>
                    </a>
                    {% if produto.ativo %}
                        <form action="{% url 'inventario:pausar_produto' pk=produto.pk %}" method="post" class="d-inline" onsubmit="return confirm('Pausar este produto?');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-secondary btn-sm py-0 px-2" title="Pausar">
                                <i class="bi bi-pause-fill"></i>
                            </button>
                        </form>
                    {% else %}
                        <form action="{% url 'inventario:reativar_produto' pk=produto.pk %}" method="post" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success btn-sm py-0 px-2" title="Reativar">
                                <i class="bi bi-play-fill"></i>
                            </button>
                        </form>
                        <form action="{% url 'inventario:excluir_produto_permanente' pk=produto.pk %}" method="post" class="d-inline" onsubmit="return confirm('EXCLUSÃO PERMANENTE!\n\nContinuar?');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger btn-sm py-0 px-2" title="Excluir">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>
    {% empty %}
        <div class="text-center py-5">
            <i class="bi bi-inbox display-1 text-muted"></i>
            <h5 class="text-muted mt-3">
                {% if query_atual %}
                    Nenhum produto encontrado para "<strong>{{ query_atual }}</strong>"
                {% else %}
                    Nenhum produto encontrado
                {% endif %}
            </h5>
            {% if not query_atual %}
                <a href="{% url 'inventario:criar_produto' %}" class="btn btn-primary mt-3">
                    <i class="bi bi-plus-circle"></i> Adicionar Primeiro Produto
                </a>
            {% endif %}
        </div>
    {% endfor %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const produtosTbodyDesktop = document.getElementById('produtos-tbody-desktop');
    const produtosCardsMobile = document.getElementById('produtos-cards-mobile');
    let searchTimeout;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const query = this.value.trim();
            const status = '{{ status_atual }}';
            buscarProdutos(query, status);
        }, 300);
    });
    
    function buscarProdutos(query, status) {
        const url = new URL('{% url "inventario:buscar_produtos_listagem_json" %}', window.location.origin);
        url.searchParams.set('q', query);
        url.searchParams.set('status', status);
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                atualizarConteudo(data.produtos, query);
            })
            .catch(error => {
                console.error('Erro na busca:', error);
            });
    }
    
    function atualizarConteudo(produtos, query) {
        // Atualizar tabela desktop
        atualizarTabelaDesktop(produtos, query);
        // Atualizar cards mobile
        atualizarCardsMobile(produtos, query);
    }
    
    function atualizarTabelaDesktop(produtos, query) {
        let html = '';
        
        if (produtos.length === 0) {
            const mensagem = query ? `Nenhum produto encontrado para "<strong>${query}</strong>"` : 'Nenhum produto encontrado';
            const botaoAdicionar = !query ? '<a href="{% url "inventario:criar_produto" %}" class="btn btn-primary mt-2"><i class="bi bi-plus-circle"></i> Adicionar Primeiro Produto</a>' : '';
            
            html = `<tr>
                <td colspan="6" class="text-center py-4">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <h5 class="text-muted mt-2">${mensagem}</h5>
                    ${botaoAdicionar}
                </td>
            </tr>`;
        } else {
            produtos.forEach(produto => {
                const margemBadge = produto.margem_lucro_agg !== null 
                    ? `<span class="badge bg-${produto.margem_cor}">${produto.margem_lucro_agg.toFixed(2)}%</span>`
                    : '<span class="badge bg-secondary">N/A</span>';
                
                const acoesBotoes = gerarBotoesAcao(produto);
                
                html += `<tr class="align-middle">
                    <td><a href="/produtos/${produto.id}/" class="fw-semibold text-decoration-none">${produto.nome}</a></td>
                    <td class="text-center"><span class="badge bg-primary">${produto.quantidade_total_agg}</span></td>
                    <td class="text-end fw-bold">R$ ${produto.preco_venda.toFixed(2)}</td>
                    <td class="text-end">R$ ${produto.custo_medio_ponderado_agg.toFixed(2)}</td>
                    <td class="text-center">${margemBadge}</td>
                    <td class="text-center">
                        <div class="btn-group" role="group">
                            <a href="/produtos/${produto.id}/" class="btn btn-sm btn-info" title="Detalhes"><i class="bi bi-eye"></i></a>
                            <a href="/produtos/${produto.id}/adicionar-estoque/" class="btn btn-sm btn-success" title="Adicionar Lote"><i class="bi bi-plus-lg"></i></a>
                            <a href="/produtos/${produto.id}/editar/" class="btn btn-sm btn-warning" title="Editar"><i class="bi bi-pencil"></i></a>
                            ${acoesBotoes}
                        </div>
                    </td>
                </tr>`;
            });
        }
        
        produtosTbodyDesktop.innerHTML = html;
    }
    
    function atualizarCardsMobile(produtos, query) {
        let html = '';
        
        if (produtos.length === 0) {
            const mensagem = query ? `Nenhum produto encontrado para "<strong>${query}</strong>"` : 'Nenhum produto encontrado';
            const botaoAdicionar = !query ? '<a href="{% url "inventario:criar_produto" %}" class="btn btn-primary mt-3"><i class="bi bi-plus-circle"></i> Adicionar Primeiro Produto</a>' : '';
            
            html = `<div class="text-center py-5">
                <i class="bi bi-inbox display-1 text-muted"></i>
                <h5 class="text-muted mt-3">${mensagem}</h5>
                ${botaoAdicionar}
            </div>`;
        } else {
            produtos.forEach(produto => {
                const margemBadge = produto.margem_lucro_agg !== null 
                    ? `<span class="badge bg-${produto.margem_cor} ms-1">${produto.margem_lucro_agg.toFixed(1)}%</span>`
                    : '<span class="badge bg-secondary ms-1">N/A</span>';
                
                const chegandoBadge = produto.quantidade_chegando > 0 
                    ? `<span class="badge bg-info text-dark">+${produto.quantidade_chegando}</span>`
                    : '';
                
                const acoesBotoesIcones = gerarBotoesIconesMobile(produto);
                
                html += `<div class="card mb-2">
                    <div class="card-body py-2 px-3">
                        <!-- Linha 1: Nome e Badges -->
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <div class="flex-grow-1">
                                <h6 class="mb-0 small">
                                    <a href="/produtos/${produto.id}/" class="text-decoration-none">
                                        <span class="fw-bold">${produto.nome}</span>
                                    </a>
                                </h6>
                                <small class="text-muted">Custo: R$ ${produto.custo_medio_ponderado_agg.toFixed(2)}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-primary">${produto.quantidade_total_agg}</span>
                                ${chegandoBadge}
                            </div>
                        </div>
                        
                        <!-- Linha 2: Preço e Margem -->
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <div>
                                <strong class="text-primary">R$ ${produto.preco_venda.toFixed(2)}</strong>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">Margem:</small>
                                ${margemBadge}
                            </div>
                        </div>
                        
                        <!-- Linha 3: Ações -->
                        <div class="d-flex flex-wrap gap-1 mt-2">
                            ${acoesBotoesIcones}
                        </div>
                    </div>
                </div>`;
            });
        }
        
        produtosCardsMobile.innerHTML = html;
    }
    
    function gerarBotoesAcao(produto) {
        if (produto.ativo) {
            return `<form action="/produtos/${produto.id}/pausar/" method="post" class="d-inline" onsubmit="return confirm('Tem certeza que deseja pausar este produto?');">
                <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                <button type="submit" class="btn btn-sm btn-secondary" title="Pausar"><i class="bi bi-pause-fill"></i></button>
            </form>`;
        } else {
            return `<form action="/produtos/${produto.id}/reativar/" method="post" class="d-inline">
                <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                <button type="submit" class="btn btn-sm btn-success" title="Reativar"><i class="bi bi-play-fill"></i></button>
            </form>
            <form action="/produtos/${produto.id}/excluir-permanente/" method="post" class="d-inline" onsubmit="return confirm('EXCLUSÃO PERMANENTE!\\n\\nEsta ação não pode ser desfeita. Continuar?');">
                <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                <button type="submit" class="btn btn-sm btn-danger" title="Excluir Permanentemente"><i class="bi bi-trash"></i></button>
            </form>`;
        }
    }
    
    function gerarBotoesIconesMobile(produto) {
        let botoes = `<a href="/produtos/${produto.id}/" class="btn btn-info btn-sm py-0 px-2" title="Ver detalhes"><i class="bi bi-eye"></i></a>
            <a href="/produtos/${produto.id}/adicionar-estoque/" class="btn btn-success btn-sm py-0 px-2" title="Adicionar lote"><i class="bi bi-plus-lg"></i></a>
            <a href="/produtos/${produto.id}/editar/" class="btn btn-warning btn-sm py-0 px-2" title="Editar"><i class="bi bi-pencil"></i></a>`;
        
        if (produto.ativo) {
            botoes += `<form action="/produtos/${produto.id}/pausar/" method="post" class="d-inline" onsubmit="return confirm('Pausar este produto?');">
                <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                <button type="submit" class="btn btn-secondary btn-sm py-0 px-2" title="Pausar"><i class="bi bi-pause-fill"></i></button>
            </form>`;
        } else {
            botoes += `<form action="/produtos/${produto.id}/reativar/" method="post" class="d-inline">
                <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                <button type="submit" class="btn btn-success btn-sm py-0 px-2" title="Reativar"><i class="bi bi-play-fill"></i></button>
            </form>
            <form action="/produtos/${produto.id}/excluir-permanente/" method="post" class="d-inline" onsubmit="return confirm('EXCLUSÃO PERMANENTE!\\n\\nContinuar?');">
                <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                <button type="submit" class="btn btn-danger btn-sm py-0 px-2" title="Excluir"><i class="bi bi-trash"></i></button>
            </form>`;
        }
        
        return botoes;
    }
});
</script>
{% endblock %} 